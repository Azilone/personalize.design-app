generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model ShopPlan {
  shop_id                         String     @id
  plan_status                     PlanStatus @default(none)
  shopify_subscription_id         String?
  shopify_subscription_status     String?
  shopify_confirmation_url        String?
  free_usage_gift_cents           Int        @default(0)
  free_usage_gift_remaining_cents Int        @default(0)
  created_at                      DateTime   @default(now())
  updated_at                      DateTime   @updatedAt

  @@map("shop_plans")
}

model ShopSpendSafety {
  shop_id               String    @id
  monthly_cap_cents     Int?
  paid_usage_consent_at DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@map("shop_spend_safety")
}

model ShopStorefrontPersonalization {
  shop_id                            String   @id
  storefront_personalization_enabled Boolean  @default(false)
  created_at                         DateTime @default(now())
  updated_at                         DateTime @updatedAt

  @@map("shop_storefront_personalization")
}

model ShopPrintifyIntegration {
  shop_id                String   @id
  token_ciphertext       String
  token_iv               String
  token_auth_tag         String
  printify_shop_id       String
  printify_shop_title    String
  printify_sales_channel String?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("shop_printify_integrations")
}

model DesignTemplate {
  id                          String                   @id @default(cuid())
  shop_id                     String
  template_name               String
  photo_required              Boolean                  @default(true)
  text_input_enabled          Boolean                  @default(false)
  prompt                      String?
  generation_model_identifier String?
  price_usd_per_generation    Decimal?
  remove_background_enabled   Boolean                  @default(false)
  aspect_ratio                TemplateAspectRatio      @default(ratio_1_1)
  status                      DesignTemplateStatus     @default(draft)
  test_generation_count       Int                      @default(0)
  test_generation_month       String?
  created_at                  DateTime                 @default(now())
  updated_at                  DateTime                 @updatedAt
  variables                   DesignTemplateVariable[]
  testGenerations             TemplateTestGeneration[]

  @@index([shop_id])
  @@map("design_templates")
}

model TemplateTestGeneration {
  id                   String         @id @default(cuid())
  template_id          String
  shop_id              String
  num_images_requested Int
  num_images_generated Int
  total_cost_usd       Decimal
  total_time_seconds   Decimal
  success              Boolean
  error_message        String?
  created_at           DateTime       @default(now())
  generation_cost_usd  Decimal?
  remove_bg_cost_usd   Decimal?
  result_images        String?
  template             DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@index([template_id])
  @@index([shop_id])
  @@map("template_test_generations")
}

model DesignTemplateVariable {
  id          String         @id @default(cuid())
  template_id String
  name        String
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  template    DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([template_id, name])
  @@map("design_template_variables")
}

model ShopProduct {
  id                 String   @id @default(cuid())
  shop_id            String
  product_id         String
  title              String
  handle             String
  image_url          String?
  image_alt          String?
  printify_product_id String?
  printify_shop_id   String?
  synced_at          DateTime @default(now())
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([shop_id])
  @@unique([shop_id, product_id])
  @@map("shop_products")
}

model ProductTemplateAssignment {
  id                       String   @id @default(cuid())
  shop_id                  String
  product_id               String
  template_id              String
  personalization_enabled  Boolean  @default(false)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  @@unique([shop_id, product_id])
  @@index([shop_id])
  @@index([template_id])
  @@map("product_template_assignments")
}

model MerchantPreview {
  id               String                @id @default(cuid())
  job_id           String
  shop_id          String
  product_id       String
  template_id      String
  status           MerchantPreviewStatus @default(queued)
  cover_print_area Boolean               @default(false)
  test_image_url   String
  test_text        String?
  variable_values  Json?
  design_url       String?
  mockup_urls      Json?
  error_message    String?
  created_at       DateTime              @default(now())
  updated_at       DateTime              @updatedAt

  @@unique([shop_id, job_id])
  @@index([shop_id])
  @@index([job_id])
  @@map("merchant_previews")
}

model UsageLedgerEntry {
  id              String               @id @default(cuid())
  shop_id         String
  entry_type      UsageLedgerEntryType
  amount_cents    Int
  currency_code   String               @default("USD")
  idempotency_key String
  description     String?
  created_at      DateTime             @default(now())

  @@index([shop_id, created_at])
  @@unique([shop_id, idempotency_key])
  @@map("usage_ledger_entries")
}

enum PlanStatus {
  none
  standard
  early_access
  standard_pending
  early_access_pending
}

enum DesignTemplateStatus {
  draft
  published
}

enum TemplateAspectRatio {
  ratio_1_1
  ratio_3_4
  ratio_4_3
  ratio_9_16
  ratio_16_9
}

enum MerchantPreviewStatus {
  queued
  generating
  creating_mockups
  done
  failed
}

enum UsageLedgerEntryType {
  gift_grant
  gift_spend
  paid_usage
  adjustment
}
