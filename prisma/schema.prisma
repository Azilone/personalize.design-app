generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model ShopPlan {
  shop_id                         String     @id
  plan_status                     PlanStatus @default(none)
  shopify_subscription_id         String?
  shopify_subscription_status     String?
  shopify_confirmation_url        String?
  free_usage_gift_cents           Int        @default(0)
  free_usage_gift_remaining_cents Int        @default(0)
  created_at                      DateTime   @default(now())
  updated_at                      DateTime   @updatedAt

  @@map("shop_plans")
}

model ShopSpendSafety {
  shop_id               String    @id
  monthly_cap_cents     Int?
  paid_usage_consent_at DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  @@map("shop_spend_safety")
}

model ShopStorefrontPersonalization {
  shop_id                            String   @id
  storefront_personalization_enabled Boolean  @default(false)
  created_at                         DateTime @default(now())
  updated_at                         DateTime @updatedAt

  @@map("shop_storefront_personalization")
}

model ShopGenerationLimits {
  shop_id              String   @id
  per_product_limit    Int      @default(5)
  per_session_limit    Int      @default(15)
  reset_window_minutes Int      @default(30)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("shop_generation_limits")
}

model ShopPrintifyIntegration {
  shop_id                String   @id
  token_ciphertext       String
  token_iv               String
  token_auth_tag         String
  printify_shop_id       String
  printify_shop_title    String
  printify_sales_channel String?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("shop_printify_integrations")
}

model ShopOnboarding {
  shop_id      String   @id
  completed_at DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("shop_onboarding")
}

model ShopButtonStyles {
  shop_id                    String   @id
  use_custom                 Boolean  @default(false)
  background_color           String?
  text_color                 String?
  border_radius              String?
  font_size                  String?
  font_weight                String?
  letter_spacing             String?
  padding_x                  String?
  padding_y                  String?
  border_width               String?
  border_color               String?
  box_shadow                 String?
  hover_background_color     String?
  hover_text_color           String?
  hover_box_shadow           String?
  disabled_background_color  String?
  disabled_text_color        String?
  created_at                 DateTime @default(now())
  updated_at                 DateTime @updatedAt

  @@map("shop_button_styles")
}

model DesignTemplate {
  id                          String                   @id @default(cuid())
  shop_id                     String
  template_name               String
  photo_required              Boolean                  @default(true)
  text_input_enabled          Boolean                  @default(false)
  prompt                      String?
  generation_model_identifier String?
  price_usd_per_generation    Decimal?
  remove_background_enabled   Boolean                  @default(false)
  cover_print_area            Boolean                  @default(true)
  aspect_ratio                TemplateAspectRatio      @default(ratio_1_1)
  status                      DesignTemplateStatus     @default(draft)
  test_generation_count       Int                      @default(0)
  test_generation_month       String?
  created_at                  DateTime                 @default(now())
  updated_at                  DateTime                 @updatedAt
  variables                   DesignTemplateVariable[]
  testGenerations             TemplateTestGeneration[]

  @@index([shop_id])
  @@map("design_templates")
}

model TemplateTestGeneration {
  id                   String         @id @default(cuid())
  template_id          String
  shop_id              String
  num_images_requested Int
  num_images_generated Int
  total_cost_usd       Decimal
  total_time_seconds   Decimal
  success              Boolean
  error_message        String?
  created_at           DateTime       @default(now())
  generation_cost_usd  Decimal?
  remove_bg_cost_usd   Decimal?
  result_images        String?
  template             DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@index([template_id])
  @@index([shop_id])
  @@map("template_test_generations")
}

model DesignTemplateVariable {
  id          String         @id @default(cuid())
  template_id String
  name        String
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  template    DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([template_id, name])
  @@map("design_template_variables")
}

model ShopProduct {
  id                 String   @id @default(cuid())
  shop_id            String
  product_id         String
  title              String
  handle             String
  image_url          String?
  image_alt          String?
  printify_product_id String?
  printify_shop_id   String?
  synced_at          DateTime @default(now())
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([shop_id])
  @@unique([shop_id, product_id])
  @@map("shop_products")
}

model ShopProductVariant {
  id                  String   @id @default(cuid())
  shop_id             String
  shopify_product_id  String
  shopify_variant_id  String
  printify_product_id String
  printify_variant_id String
  variant_title       String
  synced_at           DateTime @default(now())
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  @@index([shop_id])
  @@index([shop_id, shopify_product_id])
  @@unique([shop_id, shopify_variant_id])
  @@map("shop_product_variants")
}

model ProductTemplateAssignment {
  id                       String   @id @default(cuid())
  shop_id                  String
  product_id               String
  template_id              String
  personalization_enabled  Boolean  @default(false)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  @@unique([shop_id, product_id])
  @@index([shop_id])
  @@index([template_id])
  @@map("product_template_assignments")
}

model PreviewJob {
  id                       String           @id @default(cuid())
  job_id                   String
  shop_id                  String
  product_id               String
  variant_id               String?
  template_id              String
  type                     PreviewJobType

  input_image_url          String?
  input_text               String?
  variable_values          Json?
  cover_print_area         Boolean          @default(false)

  design_url               String?
  design_storage_key       String?
  mockup_urls              Json?
  temp_printify_product_id String?

  session_id               String?

  status                   PreviewJobStatus @default(queued)
  error_message            String?
  mockup_error_message     String?

  created_at               DateTime         @default(now())
  updated_at               DateTime         @updatedAt

  @@unique([shop_id, job_id])
  @@index([shop_id])
  @@index([job_id])
  @@index([type])
  @@map("preview_jobs")
}

model UsageLedgerEntry {
  id              String               @id @default(cuid())
  shop_id         String
  entry_type      UsageLedgerEntryType
  amount_cents    Int
  amount_mills    Int                  @default(0)
  currency_code   String               @default("USD")
  idempotency_key String
  description     String?
  created_at      DateTime             @default(now())

  @@index([shop_id, created_at])
  @@unique([shop_id, idempotency_key])
  @@map("usage_ledger_entries")
}

enum PlanStatus {
  none
  standard
  early_access
  standard_pending
  early_access_pending
}

enum DesignTemplateStatus {
  draft
  published
}

enum TemplateAspectRatio {
  ratio_1_1
  ratio_3_4
  ratio_4_3
  ratio_9_16
  ratio_16_9
}

enum PreviewJobType {
  buyer
  merchant
  template_test
}

enum PreviewJobStatus {
  queued
  generating
  processing
  creating_mockups
  done
  failed
  mockups_failed
}

enum UsageLedgerEntryType {
  gift_grant
  gift_spend
  paid_usage
  adjustment
}

model BillableEvent {
  id              String              @id @default(cuid())
  shop_id         String
  event_type      BillableEventType
  status          BillableEventStatus @default(pending)
  amount_mills    Int
  currency_code   String              @default("USD")
  idempotency_key String
  description     String?
  source_id       String?
  error_message   String?
  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt

  @@index([shop_id, created_at])
  @@unique([shop_id, idempotency_key])
  @@map("billable_events")
}

model OrderLineProcessing {
  id                 String   @id @default(cuid())
  shop_id            String
  order_id           String
  order_line_id      String
  idempotency_key    String   @unique
  status             String   // pending, processing, succeeded, failed
  personalization_id String

  // Final print-ready asset reference (AC: 1, 2)
  final_asset_storage_key String?
  final_asset_bucket      String?
  final_asset_checksum    String?
  final_asset_persisted_at DateTime?
  final_asset_error_code  String?
  final_asset_error_message String?

  // Printify fulfillment tracking (Story 7.3)
  printify_order_id           String?   // Printify order ID from submission response
  printify_order_number       Int?      // Printify order number for display
  printify_submit_status      String?   // pending, succeeded, failed
  printify_submit_idempotency_key String? @unique // Idempotency key for submission
  printify_submitted_at       DateTime? // When submitted to Printify
  printify_error_code         String?   // Error code if submission failed
  printify_error_message      String?   // Error message if submission failed
  printify_order_status        String?  // Printify order status from webhooks
  printify_order_status_updated_at DateTime?
  printify_last_event          String?
  printify_last_event_at       DateTime?
  printify_tracking_number     String?
  printify_tracking_url        String?
  printify_tracking_carrier    String?
  printify_shipped_at          DateTime?
  printify_delivered_at        DateTime?

  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([shop_id, order_line_id])
  @@index([status])
  @@index([printify_submit_status])
  @@map("order_line_processing")
}

enum BillableEventType {
  generation
  regeneration
  remove_bg
  order_fee
}

enum BillableEventStatus {
  pending
  confirmed
  failed
  waived
}

model GenerationAttempt {
  id                  String   @id @default(cuid())
  shop_id             String
  session_id          String
  product_id          String
  attempt_count       Int      @default(0)
  first_attempt_at    DateTime @default(now())
  last_attempt_at     DateTime @updatedAt
  reset_window_minutes Int     @default(30)
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  @@unique([shop_id, session_id, product_id])
  @@index([shop_id, session_id])
  @@index([shop_id, product_id])
  @@index([last_attempt_at])
  @@map("generation_attempts")
}
