// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

enum PlanStatus {
  none
  standard
  early_access
  standard_pending
  early_access_pending
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model ShopPlan {
  shop_id                        String     @id
  plan_status                    PlanStatus @default(none)
  shopify_subscription_id        String?
  shopify_subscription_status    String?
  shopify_confirmation_url       String?
  free_usage_gift_cents          Int        @default(0)
  free_usage_gift_remaining_cents Int       @default(0)
  created_at                     DateTime   @default(now())
  updated_at                     DateTime   @updatedAt

  @@map("shop_plans")
}

model ShopSpendSafety {
  shop_id                String   @id
  monthly_cap_cents      Int?
  paid_usage_consent_at  DateTime?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("shop_spend_safety")
}

model ShopStorefrontPersonalization {
  shop_id                             String   @id
  storefront_personalization_enabled  Boolean  @default(false)
  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  @@map("shop_storefront_personalization")
}

model ShopPrintifyIntegration {
  shop_id                String   @id
  token_ciphertext       String
  token_iv               String
  token_auth_tag         String
  printify_shop_id       String
  printify_shop_title    String
  printify_sales_channel String?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("shop_printify_integrations")
}

enum DesignTemplateStatus {
  draft
  published
}

model DesignTemplate {
  id                           String               @id @default(cuid())
  shop_id                      String
  template_name                String
  photo_required               Boolean              @default(true)
  text_input_enabled           Boolean              @default(false)
  prompt                       String?
  generation_model_identifier  String?
  price_usd_per_generation     Decimal?
  remove_background_enabled    Boolean              @default(false)
  status                       DesignTemplateStatus @default(draft)
  // Test generation rate limiting (per template, per month)
  test_generation_count        Int                  @default(0)
  test_generation_month        String?              // Format: "YYYY-MM"
  created_at                   DateTime             @default(now())
  updated_at                   DateTime             @updatedAt

  variables      DesignTemplateVariable[]
  testGenerations TemplateTestGeneration[]

  @@index([shop_id])
  @@map("design_templates")
}

// Stores metadata for each test generation run
model TemplateTestGeneration {
  id                       String   @id @default(cuid())
  template_id              String
  shop_id                  String
  num_images_requested       Int
  num_images_generated      Int
  total_cost_usd           Decimal
  total_time_seconds        Decimal
  generation_cost_usd      Decimal?
  remove_bg_cost_usd       Decimal?
  success                  Boolean
  error_message           String?
  created_at               DateTime @default(now())

  template DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@index([template_id])
  @@index([shop_id])
  @@map("template_test_generations")
}

model DesignTemplateVariable {
  id          String         @id @default(cuid())
  template_id String
  name        String
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt

  template DesignTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([template_id, name])
  @@map("design_template_variables")
}
