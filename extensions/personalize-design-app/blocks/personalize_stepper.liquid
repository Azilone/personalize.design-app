{% comment %}
  Personalize Button Block
  This block renders the personalize button on product pages.
  It fetches configuration from the app's database via App Proxy API.
{% endcomment %}

{% assign shop_domain = shop.permanent_domain %}
{% assign product_id = product.id %}
{% assign is_editor = request.design_mode %}

{% comment %}Check if we're in theme editor{% endcomment %}
{% assign is_theme_editor = is_editor %}

{% comment %}App Proxy base URL{% endcomment %}
{% assign app_proxy_url = '/apps/personalize' %}

{% comment %}
  Render a container that will be populated by JavaScript after fetching config from API.
  This ensures the single source of truth is the app's database.
{% endcomment %}
<div
  id="pd-stepper-container-{{ block.id }}"
  data-pd-stepper-container
  {{ block.shopify_attributes }}
  data-shop-domain="{{ shop_domain }}"
  data-product-id="{{ product_id }}"
  data-product-gid="{{ product.admin_graphql_api_id }}"
  data-product-title="{{ product.title | escape }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-variant-gid="{{ product.selected_or_first_available_variant.admin_graphql_api_id }}"
  data-variant-title="{{ product.selected_or_first_available_variant.title | escape }}"
  {% if product.featured_image %}
    data-product-image="{{ product.featured_image | image_url: width: 1400 }}"
  {% endif %}
  data-app-proxy-url="{{ app_proxy_url }}"
  data-is-theme-editor="{{ is_theme_editor }}"
  data-button-text="{{ block.settings.button_text | escape }}"
  data-button-text-applied="{{ block.settings.button_text_applied | escape }}"
  data-button-extra-classes="{{ block.settings.button_extra_classes | escape }}"
  data-button-extra-classes-applied="{{ block.settings.button_extra_classes_applied | escape }}"
  data-use-theme-style="{{ block.settings.use_theme_style }}"
  data-custom-button-selector="{{ block.settings.custom_button_selector | escape }}"
  data-button-bg-color="{{ block.settings.button_bg_color }}"
  data-button-text-color="{{ block.settings.button_text_color }}"
  data-button-padding="{{ block.settings.button_padding | escape }}"
  data-button-font-size="{{ block.settings.button_font_size | escape }}"
  style="display: none;"
>
  <div id="pd-stepper-root-{{ block.id }}" data-pd-stepper-root></div>
</div>

<script>
(function() {
  const container = document.getElementById('pd-stepper-container-{{ block.id }}');
  if (!container) return;

  const root = container.querySelector('[data-pd-stepper-root]');
  if (!root) return;

  const shopDomain = container.dataset.shopDomain;
  const productId = container.dataset.productId;
  const productGid = container.dataset.productGid;
  const appProxyUrl = container.dataset.appProxyUrl;
  const isThemeEditor = container.dataset.isThemeEditor === 'true';

  // Cache key for sessionStorage (5 minute cache)
  const productIdForConfig = productGid || productId;
  const cacheKey = `pd_config_${shopDomain}_${productIdForConfig}`;
  const cacheExpiryKey = `pd_config_expiry_${shopDomain}_${productIdForConfig}`;
  const CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes

  function loadAssets() {
    const win = window;
    win.__pd_stepper_mount_queue = win.__pd_stepper_mount_queue || [];

    if (win.__pd_stepper_assets_loaded && typeof win.__pd_stepper_mount === 'function') {
      win.__pd_stepper_mount(root);
      return;
    }

    win.__pd_stepper_mount_queue.push(root);

    if (win.__pd_stepper_assets_loading) {
      return;
    }
    win.__pd_stepper_assets_loading = true;

    const head = document.head || document.getElementsByTagName("head")[0];
    
    const existingStepperScript = document.getElementById('pd-stepper-script');
    if (existingStepperScript) {
      return;
    }
    
    // Load CSS
    const cssId = 'pd-stepper-css';
    let css = document.getElementById(cssId);
    if (!css) {
      css = document.createElement("link");
      css.id = cssId;
      css.rel = "stylesheet";
      css.href = "{{ 'personalize-stepper.css' | asset_url }}";
      head.appendChild(css);
    }

    // Load theme style detector
    const themeScriptId = 'pd-theme-detector-script';
    let themeScript = document.getElementById(themeScriptId);
    if (!themeScript) {
      themeScript = document.createElement("script");
      themeScript.id = themeScriptId;
      themeScript.src = "{{ 'theme-style-detector.js' | asset_url }}";
      themeScript.defer = true;
      head.appendChild(themeScript);
    }

    // Load stepper script with onload callback
    const stepperScriptId = 'pd-stepper-script';
    const stepperScript = document.createElement("script");
    stepperScript.id = stepperScriptId;
    stepperScript.src = "{{ 'personalize-stepper.js' | asset_url }}";
    stepperScript.defer = true;
    stepperScript.onload = function() {
      win.__pd_stepper_assets_loaded = true;
      win.__pd_stepper_assets_loading = false;
      if (typeof win.__pd_stepper_mount === 'function') {
        win.__pd_stepper_mount(root);
      }
    };
    stepperScript.onerror = function() {
      win.__pd_stepper_assets_loading = false;
      console.error('[Personalize Design] Failed to load stepper script');
    };
    head.appendChild(stepperScript);
  }

  function initializeStepper(config) {
    
    // Set data attributes for the React app
    root.dataset.shopDomain = container.dataset.shopDomain;
    root.dataset.productId = container.dataset.productId;
    root.dataset.productGid = container.dataset.productGid;
    root.dataset.productTitle = container.dataset.productTitle;
    root.dataset.variantId = container.dataset.variantId;
    root.dataset.variantGid = container.dataset.variantGid;
    root.dataset.variantTitle = container.dataset.variantTitle;
    root.dataset.productImage = container.dataset.productImage || '';
    root.dataset.templateId = config.template_id;
    root.dataset.personalizationEnabled = config.personalization_enabled;
    root.dataset.textEnabled = config.text_enabled;
    root.dataset.isPreview = config.is_preview;
    root.dataset.buttonText = container.dataset.buttonText;
    root.dataset.buttonTextApplied = container.dataset.buttonTextApplied;
    root.dataset.buttonExtraClasses = container.dataset.buttonExtraClasses;
    root.dataset.buttonExtraClassesApplied = container.dataset.buttonExtraClassesApplied;
    root.dataset.useThemeStyle = container.dataset.useThemeStyle;
    root.dataset.customButtonSelector = container.dataset.customButtonSelector;
    root.dataset.buttonBgColor = container.dataset.buttonBgColor;
    root.dataset.buttonTextColor = container.dataset.buttonTextColor;
    root.dataset.buttonPadding = container.dataset.buttonPadding;
    root.dataset.buttonFontSize = container.dataset.buttonFontSize;

    // Show container and load assets
    container.style.display = '';
    loadAssets();
  }

  function checkCache() {
    try {
      const cached = sessionStorage.getItem(cacheKey);
      const expiry = sessionStorage.getItem(cacheExpiryKey);
      
      if (cached && expiry) {
        const now = Date.now();
        if (now < parseInt(expiry)) {
          return JSON.parse(cached);
        }
        // Cache expired, clear it
        sessionStorage.removeItem(cacheKey);
        sessionStorage.removeItem(cacheExpiryKey);
      }
    } catch (e) {
      // sessionStorage not available or error
    }
    return null;
  }

  function setCache(config) {
    try {
      sessionStorage.setItem(cacheKey, JSON.stringify(config));
      sessionStorage.setItem(cacheExpiryKey, String(Date.now() + CACHE_DURATION_MS));
    } catch (e) {
      // sessionStorage not available or error
    }
  }

  function fetchConfig() {
    // Check cache first
    const cached = checkCache();
    if (cached) {
      initializeStepper(cached);
      return;
    }

    // If in theme editor, show preview mode
    if (isThemeEditor) {
      const previewConfig = {
        template_id: 'preview',
        personalization_enabled: true,
        text_enabled: true,
        is_preview: true
      };
      setCache(previewConfig);
      initializeStepper(previewConfig);
      return;
    }

    // Fetch from API
    const apiUrl = `${appProxyUrl}/product-config?shop_id=${encodeURIComponent(shopDomain)}&product_id=${encodeURIComponent(productIdForConfig)}`;
    
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.data) {
          // Product is configured
          const config = {
            template_id: data.data.template_id,
            personalization_enabled: data.data.personalization_enabled,
            text_enabled: data.data.text_enabled,
            is_preview: false
          };
          setCache(config);
          initializeStepper(config);
        } else {
          // Product not configured - keep container hidden
          // Optionally remove the container from DOM
          container.remove();
        }
      })
      .catch(error => {
        console.error('[Personalize Design] Failed to fetch product config:', error);
        // On error, don't show the button (fail closed)
        container.remove();
      });
  }

  // Start fetching config
  fetchConfig();
})();
</script>

{% schema %}
{
  "name": "Personalize Button",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "paragraph",
      "content": "The button will only appear for personalizable products published from Personalize Design. Configuration is fetched from the app's database in real-time."
    },
    {
      "type": "header",
      "content": "Button Style"
    },
    {
      "type": "checkbox",
      "id": "use_theme_style",
      "label": "Use default theme style",
      "default": true,
      "info": "When enabled, the button will automatically copy styles from your theme's Add to Cart button. If auto-detection fails, use the custom selector below."
    },
    {
      "type": "text",
      "id": "custom_button_selector",
      "label": "Custom Add to Cart Button Selector (Optional)",
      "info": "If the button styles aren't copying correctly, enter a CSS selector for your theme's Add to Cart button (e.g., '.product-form__submit' or '[name=\"add\"]'). Leave empty for auto-detection."
    },
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add personalized design"
    },
    {
      "type": "text",
      "id": "button_text_applied",
      "label": "Button Text (When Personalization Applied)",
      "default": "Remove saved design",
      "info": "Text shown on the button after personalization has been applied. Clicking this button will remove the personalization details."
    },
    {
      "type": "header",
      "content": "Button Classes"
    },
    {
      "type": "text",
      "id": "button_extra_classes",
      "label": "Button Extra Classes",
      "default": "product-form__buttons button--full-width",
      "info": "Additional CSS classes to add to the button (space-separated, e.g., 'class1 class2')"
    },
    {
      "type": "text",
      "id": "button_extra_classes_applied",
      "label": "Button Extra Classes (When Personalization Applied)",
      "default": "product-form__buttons button--full-width button--secondary",
      "info": "Additional CSS classes to add to the button when personalization is applied (space-separated, e.g., 'class1 class2')"
    },
    {
      "type": "header",
      "content": "Custom Button Styles",
      "info": "Only used when 'Use default theme style' is disabled"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Button Background Color",
      "default": "#007BFF"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "button_padding",
      "label": "Button Padding",
      "default": "12px 24px",
      "info": "CSS padding value (e.g., '12px 24px')"
    },
    {
      "type": "text",
      "id": "button_font_size",
      "label": "Font Size",
      "default": "16px",
      "info": "CSS font size (e.g., '16px')"
    }
  ]
}
{% endschema %}
