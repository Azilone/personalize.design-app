{% comment %}
  Personalize Button Block
  This block renders the personalize button on product pages.
  It fetches configuration from the app's database via App Proxy API.
{% endcomment %}

{% assign shop_domain = shop.permanent_domain %}
{% assign product_id = product.id %}
{% assign is_editor = request.design_mode %}

{% comment %}Check if we're in theme editor{% endcomment %}
{% assign is_theme_editor = is_editor %}

{% comment %}App Proxy base URL{% endcomment %}
{% assign app_proxy_url = '/apps/personalize' %}

{% comment %}
  Render a container that will be populated by JavaScript after fetching config from API.
  This ensures the single source of truth is the app's database.
{% endcomment %}
<div
  id="pd-stepper-container-{{ block.id }}"
  data-pd-stepper-container
  {{ block.shopify_attributes }}
  data-shop-domain="{{ shop_domain }}"
  data-product-id="{{ product_id }}"
  data-product-gid="{{ product.admin_graphql_api_id }}"
  data-product-handle="{{ product.handle }}"
  data-product-title="{{ product.title | escape }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-variant-gid="{{ product.selected_or_first_available_variant.admin_graphql_api_id }}"
  data-variant-title="{{ product.selected_or_first_available_variant.title | escape }}"
  {% if product.featured_image %}
    data-product-image="{{ product.featured_image | image_url: width: 1400 }}"
  {% endif %}
  {% if product.selected_or_first_available_variant.image %}
    data-variant-image="{{ product.selected_or_first_available_variant.image | image_url: width: 1400 }}"
  {% endif %}
  data-app-proxy-url="{{ app_proxy_url }}"
  data-is-theme-editor="{{ is_theme_editor }}"
  data-button-text="{{ block.settings.button_text | escape }}"
  data-button-text-applied="{{ block.settings.button_text_applied | escape }}"
  data-button-extra-classes="{{ block.settings.button_extra_classes | escape }}"
  data-button-extra-classes-applied="{{ block.settings.button_extra_classes_applied | escape }}"
  data-use-theme-style="{{ block.settings.use_theme_style }}"
  data-custom-button-selector="{{ block.settings.custom_button_selector | escape }}"
  data-button-bg-color="{{ block.settings.button_bg_color }}"
  data-button-text-color="{{ block.settings.button_text_color }}"
  data-button-padding="{{ block.settings.button_padding | escape }}"
  data-button-font-size="{{ block.settings.button_font_size | escape }}"
  style="display: none;"
>
  <div id="pd-stepper-root-{{ block.id }}" data-pd-stepper-root></div>
  <script type="application/json" data-pd-product-json>
    {{ product | json }}
  </script>
</div>

<script>
(function() {
  const container = document.getElementById('pd-stepper-container-{{ block.id }}');
  if (!container) return;

  const root = container.querySelector('[data-pd-stepper-root]');
  if (!root) return;

  const shopDomain = container.dataset.shopDomain;
  const productId = container.dataset.productId;
  const productGid = container.dataset.productGid;
  const productHandle = container.dataset.productHandle;
  const appProxyUrl = container.dataset.appProxyUrl;
  const isThemeEditor = container.dataset.isThemeEditor === 'true';

  // Cache key for sessionStorage (5 minute cache)
  const productIdForConfig = productGid || productId;
  const cacheKey = `pd_config_${shopDomain}_${productIdForConfig}`;
  const cacheExpiryKey = `pd_config_expiry_${shopDomain}_${productIdForConfig}`;
  const CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes

  function loadAssets() {
    const win = window;
    win.__pd_stepper_mount_queue = win.__pd_stepper_mount_queue || [];

    if (win.__pd_stepper_assets_loaded && typeof win.__pd_stepper_mount === 'function') {
      win.__pd_stepper_mount(root);
      return;
    }

    win.__pd_stepper_mount_queue.push(root);

    if (win.__pd_stepper_assets_loading) {
      return;
    }
    win.__pd_stepper_assets_loading = true;

    const head = document.head || document.getElementsByTagName("head")[0];
    
    const existingStepperScript = document.getElementById('pd-stepper-script');
    if (existingStepperScript) {
      return;
    }
    
    // Load CSS
    const cssId = 'pd-stepper-css';
    let css = document.getElementById(cssId);
    if (!css) {
      css = document.createElement("link");
      css.id = cssId;
      css.rel = "stylesheet";
      css.href = "{{ 'personalize-stepper.css' | asset_url }}";
      head.appendChild(css);
    }

    // Load theme style detector
    const themeScriptId = 'pd-theme-detector-script';
    let themeScript = document.getElementById(themeScriptId);
    if (!themeScript) {
      themeScript = document.createElement("script");
      themeScript.id = themeScriptId;
      themeScript.src = "{{ 'theme-style-detector.js' | asset_url }}";
      themeScript.defer = true;
      head.appendChild(themeScript);
    }

    // Load stepper script with onload callback
    const stepperScriptId = 'pd-stepper-script';
    const stepperScript = document.createElement("script");
    stepperScript.id = stepperScriptId;
    stepperScript.src = "{{ 'personalize-stepper.js' | asset_url }}";
    stepperScript.defer = true;
    stepperScript.onload = function() {
      win.__pd_stepper_assets_loaded = true;
      win.__pd_stepper_assets_loading = false;
      if (typeof win.__pd_stepper_mount === 'function') {
        win.__pd_stepper_mount(root);
      }
    };
    stepperScript.onerror = function() {
      win.__pd_stepper_assets_loading = false;
      console.error('[Personalize Design] Failed to load stepper script');
    };
    head.appendChild(stepperScript);
  }

  function initializeStepper(config) {
    const currentImage = getCurrentProductImage();
    if (currentImage) {
      const existingVariantImage = container.dataset.variantImage;
      const existingProductImage = container.dataset.productImage;
      if (!existingVariantImage || existingVariantImage === existingProductImage) {
        container.dataset.variantImage = currentImage;
        container.dataset.productImage = currentImage;
      }
    }

    // Set data attributes for the React app
    root.dataset.shopDomain = container.dataset.shopDomain;
    root.dataset.productId = container.dataset.productId;
    root.dataset.productGid = container.dataset.productGid;
    root.dataset.productTitle = container.dataset.productTitle;
    root.dataset.variantId = container.dataset.variantId;
    root.dataset.variantGid = container.dataset.variantGid;
    root.dataset.variantTitle = container.dataset.variantTitle;
    root.dataset.productImage = container.dataset.productImage || '';
    root.dataset.templateId = config.template_id;
    root.dataset.personalizationEnabled = config.personalization_enabled;
    root.dataset.textEnabled = config.text_enabled;
    root.dataset.isPreview = config.is_preview;
    root.dataset.buttonText = container.dataset.buttonText;
    root.dataset.buttonTextApplied = container.dataset.buttonTextApplied;
    root.dataset.buttonExtraClasses = container.dataset.buttonExtraClasses;
    root.dataset.buttonExtraClassesApplied = container.dataset.buttonExtraClassesApplied;
    root.dataset.useThemeStyle = container.dataset.useThemeStyle;
    root.dataset.customButtonSelector = container.dataset.customButtonSelector;
    root.dataset.buttonBgColor = container.dataset.buttonBgColor;
    root.dataset.buttonTextColor = container.dataset.buttonTextColor;
    root.dataset.buttonPadding = container.dataset.buttonPadding;
    root.dataset.buttonFontSize = container.dataset.buttonFontSize;

    // Show container and load assets
    container.style.display = '';
    loadAssets();
  }

  function checkCache() {
    try {
      const cached = sessionStorage.getItem(cacheKey);
      const expiry = sessionStorage.getItem(cacheExpiryKey);
      
      if (cached && expiry) {
        const now = Date.now();
        if (now < parseInt(expiry)) {
          return JSON.parse(cached);
        }
        // Cache expired, clear it
        sessionStorage.removeItem(cacheKey);
        sessionStorage.removeItem(cacheExpiryKey);
      }
    } catch (e) {
      // sessionStorage not available or error
    }
    return null;
  }

  function setCache(config) {
    try {
      sessionStorage.setItem(cacheKey, JSON.stringify(config));
      sessionStorage.setItem(cacheExpiryKey, String(Date.now() + CACHE_DURATION_MS));
    } catch (e) {
      // sessionStorage not available or error
    }
  }

  function fetchConfig() {
    // Check cache first
    const cached = checkCache();
    if (cached) {
      initializeStepper(cached);
      return;
    }

    // If in theme editor, show preview mode
    if (isThemeEditor) {
      const previewConfig = {
        template_id: 'preview',
        personalization_enabled: true,
        text_enabled: true,
        is_preview: true
      };
      setCache(previewConfig);
      initializeStepper(previewConfig);
      return;
    }

    // Fetch from API
    const apiUrl = `${appProxyUrl}/product-config?shop_id=${encodeURIComponent(shopDomain)}&product_id=${encodeURIComponent(productIdForConfig)}`;
    
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.data) {
          // Product is configured
          const config = {
            template_id: data.data.template_id,
            personalization_enabled: data.data.personalization_enabled,
            text_enabled: data.data.text_enabled,
            is_preview: false
          };
          setCache(config);
          initializeStepper(config);
        } else {
          // Product not configured - keep container hidden
          // Optionally remove the container from DOM
          container.remove();
        }
      })
      .catch(error => {
        console.error('[Personalize Design] Failed to fetch product config:', error);
        // On error, don't show the button (fail closed)
        container.remove();
      });
  }

  // Start fetching config
  fetchConfig();

  // Function to get the currently displayed product image
  function getCurrentProductImage() {
    // Try multiple selectors to find the main product image
    const selectors = [
      '.product__media img',
      '.product-media img', 
      '[data-product-media] img',
      '.product-single__media img',
      '.product-media-wrapper img',
      '.product-gallery img',
      '.product-images img',
      'figure.product-media img',
      '.media img',
      'img[src*="cdn.shopify.com"]'
    ];
    
    for (const selector of selectors) {
      const img = document.querySelector(selector);
      if (img && img.src && !img.src.includes('placeholder')) {
        return img.src;
      }
    }
    
    // Fallback: get any image in the product section
    const productSection = document.querySelector('section[data-section-type="product"], [data-section-id]');
    if (productSection) {
      const img = productSection.querySelector('img[src*="cdn.shopify.com"]');
      if (img) return img.src;
    }
    
    return null;
  }

  function getProductData() {
    if (container.__pdProductData) {
      return container.__pdProductData;
    }

    const jsonEl = container.querySelector('[data-pd-product-json]');
    if (!jsonEl || !jsonEl.textContent) {
      return null;
    }

    try {
      const data = JSON.parse(jsonEl.textContent);
      container.__pdProductData = data;
      return data;
    } catch (error) {
      console.warn('[Personalize Design] Failed to parse product JSON:', error);
      return null;
    }
  }

  function getVariantImageUrl(variant) {
    if (!variant) return '';

    const featuredImage = variant.featured_image;
    if (featuredImage) {
      if (typeof featuredImage === 'string') return featuredImage;
      if (featuredImage.src) return featuredImage.src;
      if (featuredImage.url) return featuredImage.url;
    }

    const image = variant.image;
    if (image) {
      if (typeof image === 'string') return image;
      if (image.src) return image.src;
      if (image.url) return image.url;
    }

    return '';
  }

  function updateVariantById(variantId) {
    if (!variantId) return;

    const productData = getProductData();
    const variantFromProduct =
      productData && productData.variants
        ? productData.variants.find((variant) => String(variant.id) === String(variantId))
        : null;

    if (variantFromProduct) {
      updateVariantData(variantFromProduct);
      return;
    }

    fetch(`/variants/${variantId}.json`)
      .then((response) => response.json())
      .then((data) => {
        if (data && data.variant) {
          updateVariantData(data.variant);
        }
      })
      .catch(() => {
        updateVariantData({
          id: variantId,
          admin_graphql_api_id: `gid://shopify/ProductVariant/${variantId}`,
          title: ''
        });
      });
  }

  // Listen for variant changes and update data attributes
  function updateVariantData(variant) {
    if (!variant) return;
    
    // Get variant image URL - try multiple sources
    let variantImage = '';
    variantImage = getVariantImageUrl(variant);
    if (!variantImage && variant.image_url) {
      variantImage = variant.image_url;
    }
    
    // If no variant-specific image, try to get the currently displayed product image
    // This catches the case where the theme updates the main image when variant changes
    if (!variantImage) {
      variantImage = getCurrentProductImage();
      if (variantImage) {
        console.log('[Personalize Design] Using currently displayed image:', variantImage.substring(0, 100));
      }
    }
    
    // Update container dataset
    container.dataset.variantId = variant.id;
    container.dataset.variantGid = variant.admin_graphql_api_id || `gid://shopify/ProductVariant/${variant.id}`;
    container.dataset.variantTitle = variant.title || '';
    if (variantImage) {
      container.dataset.variantImage = variantImage;
    }
    
    // Update root dataset (for React app)
    if (root) {
      root.dataset.variantId = variant.id;
      root.dataset.variantGid = variant.admin_graphql_api_id || `gid://shopify/ProductVariant/${variant.id}`;
      root.dataset.variantTitle = variant.title || '';
      if (variantImage) {
        root.dataset.variantImage = variantImage;
      }
    }
    
    // Dispatch custom event for React app
    container.dispatchEvent(new CustomEvent('pd:variantchange', {
      detail: {
        variantId: variant.id,
        variantGid: variant.admin_graphql_api_id || `gid://shopify/ProductVariant/${variant.id}`,
        variantTitle: variant.title,
        variantImage: variantImage
      },
      bubbles: true
    }));
    
    console.log('[Personalize Design] Variant updated:', variant.title, 'Image:', variantImage ? variantImage.substring(0, 100) + '...' : 'none');
  }

  // Listen for Shopify's variant:change event
  document.addEventListener('variant:change', function(event) {
    if (event.detail && event.detail.variant) {
      // Wait a bit for the theme to update the image
      setTimeout(() => {
        updateVariantData(event.detail.variant);
      }, 100);
    }
  });

  function getClosestProductForm() {
    const section = container.closest('[data-section-id], section, .shopify-section');
    if (section) {
      const form = section.querySelector('form[action*="/cart/add"]');
      if (form) return form;
    }

    return document.querySelector('form[action*="/cart/add"]');
  }

  function getSelectedOptionsFromForm(form) {
    const productData = getProductData();
    if (!productData || !Array.isArray(productData.options)) {
      return null;
    }

    const valuesByName = new Map();
    const optionInputs = form.querySelectorAll('input[name^="options["], select[name^="options["]');

    optionInputs.forEach((input) => {
      const nameMatch = input.name && input.name.match(/^options\[(.+)\]$/);
      if (!nameMatch) return;
      if (input.type === 'radio' && !input.checked) return;
      if (input.tagName === 'SELECT') {
        const selected = input.options[input.selectedIndex];
        if (!selected) return;
        valuesByName.set(nameMatch[1], selected.value);
        return;
      }

      if (input.value) {
        valuesByName.set(nameMatch[1], input.value);
      }
    });

    if (valuesByName.size === 0) {
      return null;
    }

    const ordered = productData.options.map((optionName) => valuesByName.get(optionName));
    if (ordered.some((value) => !value)) {
      return null;
    }

    return ordered;
  }

  function resolveVariantFromOptions(selectedOptions) {
    const productData = getProductData();
    if (!productData || !Array.isArray(productData.variants)) {
      return null;
    }

    return productData.variants.find((variant) => {
      const options = Array.isArray(variant.options)
        ? variant.options
        : [variant.option1, variant.option2, variant.option3].filter(Boolean);

      if (options.length < selectedOptions.length) {
        return false;
      }

      return selectedOptions.every((option, index) => options[index] === option);
    }) || null;
  }

  function watchVariantSelection() {
    const form = getClosestProductForm();
    if (!form) return;

    const getInitialVariantId = () => {
      const urlVariantId = new URLSearchParams(window.location.search).get('variant');
      if (urlVariantId) return urlVariantId;
      const idInput = form.querySelector('[name="id"]');
      if (idInput && idInput.value) return idInput.value;
      return container.dataset.variantId || null;
    };

    const applyInitialVariant = () => {
      const initialId = getInitialVariantId();
      if (initialId) {
        updateVariantById(initialId);
      }
    };

    if (!getProductData() && productHandle) {
      fetch(`/products/${productHandle}.js`)
        .then((response) => response.json())
        .then((data) => {
          container.__pdProductData = data;
          applyInitialVariant();
        })
        .catch(() => {
          applyInitialVariant();
        });
    } else {
      applyInitialVariant();
    }

    const idInput = form.querySelector('[name="id"]');
    let lastSeenVariantId = container.dataset.variantId;

    const handleVariantIdChange = () => {
      const nextId = idInput && idInput.value ? idInput.value : null;
      if (!nextId || nextId === lastSeenVariantId) return;
      lastSeenVariantId = nextId;
      updateVariantById(nextId);
    };

    if (idInput) {
      idInput.addEventListener('change', handleVariantIdChange);
      idInput.addEventListener('input', handleVariantIdChange);
      const observer = new MutationObserver(handleVariantIdChange);
      observer.observe(idInput, { attributes: true, attributeFilter: ['value'] });
      handleVariantIdChange();
    }

    form.addEventListener('change', () => {
      if (idInput && idInput.value) {
        handleVariantIdChange();
        return;
      }

      const selectedOptions = getSelectedOptionsFromForm(form);
      if (!selectedOptions) return;
      const resolved = resolveVariantFromOptions(selectedOptions);
      if (resolved) {
        updateVariantData(resolved);
      }
    });
  }

  watchVariantSelection();

  // Also listen for URL changes (some themes update URL without dispatching event)
  let lastVariantId = container.dataset.variantId;
  const observer = new MutationObserver(function(mutations) {
    const urlParams = new URLSearchParams(window.location.search);
    const variantId = urlParams.get('variant');
    
    if (variantId && variantId !== lastVariantId) {
      lastVariantId = variantId;
      // Fetch variant details from Shopify's global object if available
      if (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) {
        fetch(`${window.Shopify.routes.root}variants/${variantId}.json`)
          .then(r => r.json())
          .then(data => {
            if (data.variant) {
              updateVariantData(data.variant);
            }
          })
          .catch(() => {
            // Fallback: just update the ID
            updateVariantData({
              id: variantId,
              admin_graphql_api_id: `gid://shopify/ProductVariant/${variantId}`,
              title: ''
            });
          });
      }
    }
  });
  
  observer.observe(document.querySelector('body'), {
    childList: true,
    subtree: true
  });

  // Check for variant in URL on load
  const initialVariantId = new URLSearchParams(window.location.search).get('variant');
  if (initialVariantId && initialVariantId !== container.dataset.variantId) {
    lastVariantId = initialVariantId;
    updateVariantData({
      id: initialVariantId,
      admin_graphql_api_id: `gid://shopify/ProductVariant/${initialVariantId}`,
      title: ''
    });
  }
})();
</script>

{% schema %}
{
  "name": "Personalize Button",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "paragraph",
      "content": "The button will only appear for personalizable products published from Personalize Design. Configuration is fetched from the app's database in real-time."
    },
    {
      "type": "header",
      "content": "Button Style"
    },
    {
      "type": "checkbox",
      "id": "use_theme_style",
      "label": "Use default theme style",
      "default": true,
      "info": "When enabled, the button will automatically copy styles from your theme's Add to Cart button. If auto-detection fails, use the custom selector below."
    },
    {
      "type": "text",
      "id": "custom_button_selector",
      "label": "Custom Add to Cart Button Selector (Optional)",
      "info": "If the button styles aren't copying correctly, enter a CSS selector for your theme's Add to Cart button (e.g., '.product-form__submit' or '[name=\"add\"]'). Leave empty for auto-detection."
    },
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add personalized design"
    },
    {
      "type": "text",
      "id": "button_text_applied",
      "label": "Button Text (When Personalization Applied)",
      "default": "Remove saved design",
      "info": "Text shown on the button after personalization has been applied. Clicking this button will remove the personalization details."
    },
    {
      "type": "header",
      "content": "Button Classes"
    },
    {
      "type": "text",
      "id": "button_extra_classes",
      "label": "Button Extra Classes",
      "default": "product-form__buttons button--full-width",
      "info": "Additional CSS classes to add to the button (space-separated, e.g., 'class1 class2')"
    },
    {
      "type": "text",
      "id": "button_extra_classes_applied",
      "label": "Button Extra Classes (When Personalization Applied)",
      "default": "product-form__buttons button--full-width button--secondary",
      "info": "Additional CSS classes to add to the button when personalization is applied (space-separated, e.g., 'class1 class2')"
    },
    {
      "type": "header",
      "content": "Custom Button Styles",
      "info": "Only used when 'Use default theme style' is disabled"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Button Background Color",
      "default": "#007BFF"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "button_padding",
      "label": "Button Padding",
      "default": "12px 24px",
      "info": "CSS padding value (e.g., '12px 24px')"
    },
    {
      "type": "text",
      "id": "button_font_size",
      "label": "Font Size",
      "default": "16px",
      "info": "CSS font size (e.g., '16px')"
    }
  ]
}
{% endschema %}
